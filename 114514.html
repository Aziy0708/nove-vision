<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/mui/3.7.1/css/mui.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宏瞰—协星智域云平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            /* 使用桌面提供的图片作为背景（位于同一目录） */
            background-color: #0a0f20; /* fallback */
            background-image: url('wallpaper.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #fff;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
        }
        .header {
            grid-column: 1 / 4;
            display: flex;
            justify-content: flex-start; /* 靠左排列，让天气和时间在左侧自然排列 */
            align-items: center;
            padding: 10px 0;
            gap: 18px;
        }
        /* 优化天气区域布局样式 */
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }
        .weather-icon {
            font-size: 36px;
            color: #ffcc00;
        }
        .weather-info {
            display: flex;
            gap: 20px;
        }
        .weather-info > div {
            text-align: center;
            min-width: 80px;
            padding: 5px;
            border-radius: 5px;
            transition: transform 0.3s, background-color 0.3s;
        }
        .weather-info > div:hover {
            transform: scale(1.05);
        }
        h1 {
            grid-column: 1 / 4;
            text-align: center;
            margin: 10px 0;
        }
        .nav {
            grid-column: 1 / 4;
            border-radius: 5px;
            padding: 10px 0;
            /* 半透明玻璃导航栏 */
            background: rgba(255,255,255,0.03);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
        }
        .nav li {
            margin: 0 15px;
        }
        .nav a {
            color: #fff;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        .nav a:hover {
            background-color: #2a3f6f;
        }
        .sidebar-left {
            grid-row: 3 / 4;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            border-radius: 5px;
            padding: 15px;
        }
        .card-title {
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid #2a3f6f;
            padding-bottom: 5px;
            text-align: center;
        }
        .alert-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .alert-table th, .alert-table td {
            padding: 5px;
            text-align: center;
            border-bottom: 1px solid #2a3f6f;
        }
        .alert-table th {
            background-color: #2a3f6f;
        }
        .help-alert {
            height: 120px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.15s;
            text-align: center;
        }
        .help-alert:hover {
            transform: translateY(-3px);
        }
        .remote-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .remote-table th, .remote-table td {
            padding: 5px;
            text-align: center;
            border-bottom: 1px solid #2a3f6f;
        }
        .remote-table th {
            background-color: #2a3f6f;
        }
        .main {
            grid-row: 3 / 4;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .camera {
            width: 100%;
            height: 100%;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ddd;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .camera:hover {
            transform: scale(1.01);
        }
        .sidebar-right {
            grid-row: 3 / 4;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-card {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .table-card {
            border-radius: 5px;
            padding: 15px;
        }

        /* 统一玻璃模糊（高斯模糊）面板样式 */
        .card, .header-left, .nav, .help-alert, .table-card, .camera, .weather-info > div, .chart-card, .main {
            background: rgba(255,255,255,0.04);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.06);
        }
        .line-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .line-table th, .line-table td {
            padding: 5px;
            text-align: center;
            border-bottom: 1px solid #2a3f6f;
        }
        .line-table th {
            background-color: #2a3f6f;
        }
        /* 时间卡片样式优化 */
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .time-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            padding: 10px 16px;
            border-radius: 10px;
            min-width: 170px;
            text-align: center;
            box-shadow: 0 6px 18px rgba(2,8,23,0.45);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.03);
        }
        .current-time {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
            display: inline-flex;
            align-items: baseline;
            justify-content: center;
            gap: 6px;
        }
        .current-time .time-main {
            font-size: 32px;
            font-weight: 800;
        }
        .current-time .time-sec {
            font-size: 14px;
            color: rgba(255,255,255,0.85);
            transform-origin: center;
            transition: transform 120ms linear;
        }
        .sep {
            display: inline-block;
            width: 6px;
        }
        .sep.blink {
            animation: blink 1s steps(2, start) infinite;
        }
        @keyframes blink { 50% { opacity: 0 } }
        .current-date {
            margin-top: 4px;
            font-size: 12px;
            color: #cfd8ff;
            opacity: 0.95;
        }
        /* 时间控件 */
        .time-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            justify-content: center;
        }
        .time-controls button {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            color: #e8eefc;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s, transform 0.08s;
        }
        .time-controls button.active {
            background: linear-gradient(90deg, rgba(80,120,255,0.18), rgba(80,200,255,0.06));
            border-color: rgba(120,170,255,0.25);
            transform: translateY(-1px);
        }
        .time-controls button:focus { outline: none; box-shadow: 0 0 0 3px rgba(80,120,255,0.06); }
        @media (max-width: 800px) {
            .current-time { font-size: 20px }
            .current-time .time-main { font-size: 22px }
            .time-card { min-width: 120px; padding: 8px 10px }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <!-- 天气图标（放大后放在左侧） -->
                <div class="weather-icon">
                    <span class="mui-icon mui-icon-gear"></span>
                </div>
                <!-- 三列信息：天气状况、城市、温度 -->
                <div class="weather-info">
                    <div class="weather-condition">晴</div>
                    <div class="city">无锡</div>
                    <div class="temperature">16℃</div>
                </div>
            </div>
            <div class="header-right">
                <div class="time-card" aria-label="当前时间">
                    <div id="currentTime" class="current-time" role="timer" aria-live="polite"><span class="time-main">13:14</span><span class="sep blink">:</span><span class="time-sec">00</span></div>
                    <div id="currentDate" class="current-date">2024年10月11日 星期五</div>
                </div>
            </div>
        </div>
        <h1 style="margin-top: -70px;">宏瞰—协星智域云平台</h1>
        <div class="nav">
            <ul>
                <li><a href=" ">线路跟踪</a ></li>
                <li><a href="#">求助预警</a ></li>
                <li><a href="#">行为管理</a ></li>
                <li><a href="#">设备管理</a ></li>
                <li><a href="#">远程操作</a ></li>
                <li><a href="#">人员管理</a ></li>
            </ul>
        </div>
        <div class="sidebar-left">
            <div class="card">
                <div class="card-title">异常预警</div>
                <table class="alert-table">
                    <thead>
                        <tr>
                            <th>区域</th>
                            <th>人员</th>
                            <th>行为</th>
                            <th>时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>一区</td>
                            <td>2</td>
                            <td>爬树失衡</td>
                            <td>13:45</td>
                        </tr>
                        <tr>
                            <td>二区</td>
                            <td>1</td>
                            <td>电灯公德</td>
                            <td>14:56</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card">
                <div class="card-title">求助预警</div>
                <div class="help-alert">
                    <span>暂无</span>
                </div>
            </div>
            <div class="card">
                <div class="card-title">远程操作</div>
                <table class="remote-table">
                    <thead>
                        <tr>
                            <th>区域</th>
                            <th>请求</th>
                            <th>空开</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>信息工程系</td>
                            <td>0</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>旅游管理系</td>
                            <td>0</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>酒店管理系</td>
                            <td>0</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>商贸物流系</td>
                            <td>0</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>财会金融系</td>
                            <td>0</td>
                            <td>0</td>
                        <tr>
                            <td>升学部</td>
                            <td>0</td>
                            <td>0</td>
                        </tr>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="main">
            <div class="camera" id="mainCam">主摄像头画面</div>
        </div>
        <div class="sidebar-right">
            <div class="card">
                <div class="card-title">人员情况</div>
                <div class="chart-card">
                    <canvas id="peopleChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-title">设备接入情况</div>
                <div class="chart-card">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
            <div class="table-card">
                <div class="card-title">线路跟踪</div>
                <table class="line-table">
                    <thead>
                        <tr>
                            <th>UPS</th>
                            <th>主电</th>
                            <th>灯1</th>
                            <th>灯2</th>
                            <th>灯3</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                        </tr>
                        <tr>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                        </tr>
                        <tr>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                            <td>正常</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- 时间和日期（实时刷新） ---
        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' });
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }
        updateDateTime();
        setInterval(updateDateTime, 60000); // 每分钟刷新时间显示

        // --- 天气与城市（通过 IP 获取城市，再用 Open-Meteo 获取实时天气） ---
        const cityEl = document.querySelector('.city');
        const condEl = document.querySelector('.weather-condition');
        const tempEl = document.querySelector('.temperature');
        const iconEl = document.querySelector('.weather-icon');

        // Open-Meteo weathercode -> 描述与图标（简易）
        function mapWeatherCode(code) {
            // 参考 Open-Meteo weathercode
            const map = {
                0: ['晴', '☀️'],
                1: ['主要晴朗', '🌤️'],
                2: ['部分多云', '⛅'],
                3: ['多云', '☁️'],
                45: ['雾', '🌫️'],
                48: ['霜雾', '🌫️'],
                51: ['小雨（毛毛雨）', '🌦️'],
                53: ['中雨（细雨）', '🌧️'],
                55: ['大雨（连雨）', '🌧️'],
                56: ['小冻雨', '🌧️'],
                57: ['冻雨', '🌧️'],
                61: ['小雨', '🌧️'],
                63: ['中雨', '🌧️'],
                65: ['大雨', '🌧️'],
                66: ['小冻雨', '🌧️'],
                67: ['冻雨', '🌧️'],
                71: ['小雪', '🌨️'],
                73: ['中雪', '🌨️'],
                75: ['大雪', '🌨️'],
                77: ['冰粒', '🌨️'],
                80: ['阵雨', '🌦️'],
                81: ['阵雨（中）', '🌦️'],
                82: ['强阵雨', '⛈️'],
                85: ['小雪（阵）', '🌨️'],
                86: ['大雪（阵）', '🌨️'],
                95: ['雷暴', '⛈️'],
                96: ['雷暴伴有小冰雹', '⛈️'],
                99: ['雷暴伴有大冰雹', '⛈️']
            };
            return map[code] || ['未知', '❓'];
        }

        async function fetchLocation() {
            // 优先尝试通过 IP 服务获取位置
            try {
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error('ipapi failure');
                const data = await res.json();
                let city = data.city || data.region || '无锡';
                let lat = parseFloat(data.latitude);
                let lon = parseFloat(data.longitude);

                if (!isFinite(lat) || !isFinite(lon)) {
                    // 默认到无锡经纬度（示例）
                    lat = 31.574; lon = 120.301;
                }

                // 如果 city 中不包含中文字符，则尝试用 Nominatim 反向地理编码获取中文名称
                if (!/[\u4e00-\u9fff]/.test(city)) {
                    try {
                        const nomUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-CN`;
                        const nomRes = await fetch(nomUrl, { headers: { 'User-Agent': 'web-app' } });
                        if (nomRes.ok) {
                            const nom = await nomRes.json();
                            const addr = nom.address || {};
                            city = addr.city || addr.town || addr.village || addr.county || addr.state || nom.display_name || city;
                        }
                    } catch (e) {
                        console.warn('Nominatim 反向地理编码失败：', e);
                    }
                }

                return { city: city || '无锡', lat, lon };
            } catch (e) {
                console.warn('获取 IP 定位失败，尝试使用浏览器定位或默认值', e);
                // 回退到浏览器定位或默认
                return new Promise((resolve) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            const lat = pos.coords.latitude;
                            const lon = pos.coords.longitude;
                            (async () => {
                                try {
                                    const nomRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-CN`, { headers: { 'User-Agent': 'web-app' } });
                                    if (nomRes.ok) {
                                        const nom = await nomRes.json();
                                        const addr = nom.address || {};
                                        const city = addr.city || addr.town || addr.village || addr.county || addr.state || nom.display_name || '本地位置';
                                        resolve({ city, lat, lon });
                                        return;
                                    }
                                } catch (e) {
                                    console.warn('浏览器定位后反向编码失败', e);
                                }
                                resolve({ city: '本地位置', lat, lon });
                            })();
                        }, () => {
                            resolve({ city: '无锡', lat: 31.574, lon: 120.301 });
                        }, { timeout: 5000 });
                    } else {
                        resolve({ city: '无锡', lat: 31.574, lon: 120.301 });
                    }
                });
            }
        }

        async function fetchWeather(lat, lon) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=celsius&timezone=auto`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('open-meteo fail');
                const data = await res.json();
                return data.current_weather; // {temperature, windspeed, weathercode, time}
            } catch (e) {
                console.error('获取天气失败', e);
                return null;
            }
        }

        async function updateCityWeather() {
            const loc = await fetchLocation();
            // 城市固定显示为无锡（即使定位返回其他城市）
            cityEl.textContent = '无锡';
            // 先显示加载状态
            condEl.textContent = '加载中';
            tempEl.textContent = '--℃';
            iconEl.innerHTML = '⏳';

            const weather = await fetchWeather(loc.lat, loc.lon);
            if (weather) {
                const [desc, icon] = mapWeatherCode(weather.weathercode);
                condEl.textContent = desc;
                iconEl.innerHTML = `<span style="font-size:34px">${icon}</span>`;
                // 温度取整数并显示当天高低不可直接从 current_weather 获取高低，显示当前温度
                tempEl.textContent = `${Math.round(weather.temperature)}℃`;
            } else {
                condEl.textContent = '无法获取天气';
                tempEl.textContent = '--';
                iconEl.innerHTML = '❌';
            }
        }

        // 首次获取与定时刷新（10 分钟）
        updateCityWeather();
        setInterval(updateCityWeather, 10 * 60 * 1000);

        // --- 页面其他交互 & 图表（保持原有功能） ---
        document.getElementById('mainCam').addEventListener('click', () => {
            alert('点击主摄像头区域，可接入真实摄像头流或切换画面');
        });

        // 人员情况图表（模拟）
        const peopleCtx = document.getElementById('peopleChart').getContext('2d');
        new Chart(peopleCtx, {
            type: 'bar',
            data: {
                labels: ['区域1', '区域2', '区域3', '区域4'],
                datasets: [{
                    label: '人数',
                    data: [12, 19, 8, 15],
                    // 统一为鲜蓝（统一颜色以便识别）
                    backgroundColor: 'rgba(0,123,255,0.95)',
                    borderColor: 'rgba(0,90,200,1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 设备接入情况图表（模拟）
        const deviceCtx = document.getElementById('deviceChart').getContext('2d');
        new Chart(deviceCtx, {
            type: 'pie',
            data: {
                labels: ['已接入', '未接入', '故障'],
                datasets: [{
                    data: [1, 0, 0],
                    backgroundColor: [
                        'rgba(34, 139, 34, 0.7)',
                        'rgba(255, 165, 0, 0.7)',
                        'rgba(255, 0, 0, 0.7)'
                    ],
                    borderColor: [
                        'rgba(34, 139, 34, 1)',
                        'rgba(255, 165, 0, 1)',
                        'rgba(255, 0, 0, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    </script>
</body>
</html>